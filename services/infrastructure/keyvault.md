# Azure Key Vault

Azure Key Vault helps you safeguard cryptographic keys and other secrets used by cloud apps and services.

Azure Key Vault focuses on three things:

1. Certificate Management
    Easily provision, manage and deploy public and private SSL certificates for use with Azure and internal connected resources.
1. Key Management
    Create and control the encryption keys used to encrypt your data
1. Secrets Management
    Store and tightly control access to tokens, passwords, certificates, API keys, and other secrets.

## HSM and FIPS

An HSM is a Hardware Security Module. Its a piece of hardware designed to store encryption keys.

**Federal Information Processing Standards (FIPS)**
US and Canadian government standard that specifies the security requirement for cryptographic modules that protect sensitive information.

HSM's that are **multi-tenant** are FIPS 140-2 Level 2 Compliant - multiple customers virtually isolated on an HSM.
HSM's that are **single tenant** are FIPS 140-2 level 3 compliant - single customer on a dedicated HSM.

## Vault

A Vault store secrets and keys, that can be safeguarded by software or FIPS 140-2 Level 2 validated HSMs

Azure Key Vaults provides two types of containers:

* Vault - supports, software and HSM backed keys
* HSM pools - only supports HSM backed keys
    * To activate your HSM, you will need to:
        * provide a minimum of three RSA key-pairs (up to a maximum of 10)
        * specify the minimum number of keys required to decrypt the security domain (called a quorum)

> [!NOTE]
> You do not choose the container on creation; you just choose between **Standard** and **Premium**. When you choose Premium and create enough RSA key paris you will being to use HSM pools.

### Azure Key Vault REST API

![](https://learn.microsoft.com/en-us/azure/key-vault/media/azure-key-vault.png)

Azure Key Vault REST API is used for programmatically managing Azure Key Vault resources, allowing you to perform opertions such as:
* Create or key or secret
* Import a key or secret
* Revoke a key or secret
* Delete a key or secret
* Authorize user or apps to access its keys or secrets
* Monitor and manage key usage

Azure Key Vault REST API supports three different types of authentication:

1. **Managed Identities** - Identity managed by Azure AD (recommended as best practice)
1. **Service Principal and Certificate** - Uses a certificate for authentication
1. **Service Principal and Secret** - User identity and secret key

## Double Encryption

Double encryption is where two or more independent layers of encryption are enabled to protect against compromises of any one layer of encryption.

### Data at Rest

Microsoft’s approach to enabling two layers of encryption for data at rest is:

* **Encryption at rest using customer-managed keys** - You provide your own key for data encryption at rest. You can bring your own keys to your Key Vault (BYOK – Bring Your Own Key), or generate new keys in Azure Key Vault to encrypt the desired resources.
* **Infrastructure encryption using platform-managed keys**  - By default, data is automatically encrypted at rest using platform-managed encryption keys.

### Data in Transit

Microsoft’s approach to enabling two layers of encryption for data in transit is:

* Transit encryption using Transport Layer Security (TLS) 1.2 - All traffic leaving a datacenter is encrypted in transit, event if the traffic destination is another domain controller in the same region. TLS 1.2 is the default.
* Additional layers of encryption provided at the infrastructure layer - Whenever Azure customer traffic moves between datacenters --outside physical boundaries not controlled by Microsoft or on behalf of Microsoft-- A data link layer encryption method using [IEEE 802.1AE MAC Security Standards](https://1.ieee802.org/security/802-1ae/) (also known as MACsec) is applied from point-to-point across the underlying network hardware. The packets are encrypted and decrypted on the devices before being sent, preventing physical "man-in-the-middle" or snooping/wiretapping attacks. This MACsec encryption is on by default for all Azure traffic traveling within a region or between regions, and no action is reuqired on customer's part to enable.

## Keys

When creating a key, there are three options:

1. Generate - Azure will generate the key
1. Import - Import from existing RSA key
1. Restore Backup - Restore a key from backup

> [!NOTE]
> For keys generated by Azure, you can use either RSA or EC.

RSA - Encryption length are 2048, 3072, 4096
EC - Encryption length are P-256, P-384, P-521, P-256K

![](https://i.stack.imgur.com/wTc0l.png)

For Keys generated by Azure, you can set an **Activation Date** and an **Expiration Date**.

![](https://i.stack.imgur.com/XA76K.png)

You can also create new versions of a key and download it.

## Key Management

### Microsoft Managed Key (MMK)

MMK are keys managed by Microsoft. They do not appear in your vault and in most cases are used by default for many Azure services.

### Customer Managed Key (CMK)

CMK are keys you create in Azure Key Vault. You need to select from a vault for various services. In order to use a key, an Azure service needs an identity (within Azure AD) for permission to access the key from the vault.

## Secrets

Every secret stored in Key Vault is encrypted. Key Vault encrypts secrets at rest with a hierarchy of encryption keys.
* All keys in that hierarchy are protected by modules that are FIPS 140-2 compliant
* The encryption leaf key is unique to each Key Vault, while the root key is unique to the entire security world.
* The protection level may very between regions.
    * Eg, China uses FIPS 140-2 Level 1, and all other regions use level 2 or higher.

Azure Key Vault secrets provides secure storage of generic secrets, such as passwords and database connection strings.

* Key Vault APIs accept and return secret values as strings
* Internally, Key Vault stores and manages secrets:
    * As sequence of octets (8-bit bytes)
    * Each secret with a maximum size of 25k bytes
* Key Vault service does not provide semantics for secrets
    * Accepts the data, encypts it, stores it, and returns a secret identifier ("id").

> [!WARNING]
> For highly sensitive data, clients should consider additional layers of protection for data. For example, encrypting your data using a separate protection key before storing it in the Key Vault.


Key Vault also supports a **contentType** field for secrets
* Clients may specify the content type of a secret to assist in interpreting the secret data when it's retrieved
* Maximum length of this field is 255 characters.




## Pricing

Azure Key Vault has two pricing tiers:

* Standard
* Premium (Allows for both software and HSM protect keys)

| Azure key vault pricing tiers | Standard Tier | Premium Tier|
| :-: | :-: | :-: |
| First 250 keys | $5 per key per month | $5 per key per month |
| 251-1500 keys | $2.5 per key per month | $2.5 per key per month |
| 1501 - 4000 keys| $.90 per key per month | $.90 per key per month |
| 4001+ keys | $.40 per key per month | $.40 per key per month |
| Secrets operations | $0.03/10,000 transactions | $0.03/10,000 transactions |
| Certificates operations (renewals) | N/A | $3 per renewal request |
| Managed Azure Storage account key rotation | N/A | $1 per renewal |
| HSM-protected keys RSA 2048-bit keys | N/A | $1 per key per month + $0.03/10,000 transactions |
| RSA 3072 bit, RSA 4096 bit (ECC) keys | First 250 keys $5 per key per month | First 250 keys $5 per key per month |


## X.509 Certificates

<u>What is Public Key Infrastructure (PKI)?</u>
PKI is a set of roles, policies, hardware, software and procedures needed to create, manage, distribute, use, store, and revoke digital certificates and manage public-key encryption.

<u>What is an X5.09 certificate?</u>
A standard defined by the ITU for public key certificates. Use in many Internet protocols including:
* SSL/TLS and HTTPS
* Signed and encrypted email
* Code Signing and Document Signing
A certificate contains
* An identity - hostname, organization or individual
* A public key - RSA, DSA, ECDA, etc.

<u>What is a Certificate Authority?</u>

An entity that issues digital certificates. A CA acts as a trusted third party, trusted both by the subject (owner) of the certificate and by the party reyling upon the certificate.

A certificate authority can issue multiple certificates in the form a tree structure (a chain trust):

**Root Certificate Authority (Root CA)**

* A self-signed certificate, and its private key is used to sign other certificates
* Its important that the private key of the root CA are protected (usually turn off CA)

**Intermediate Certificate Authority (ICA)**

* Intermediate Certificates are signed by the root private key and act as entities that can issue certificates.
* They protect the root certificate because the root certificate does not hav to sign every issued certificate.

